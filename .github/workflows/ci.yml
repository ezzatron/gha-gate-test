name: CI

on:
  push:
  pull_request:

jobs:
  dev:
    name: Development
    runs-on: ubuntu-latest

    environment:
      name: Development

    steps:
      - name: Sleep for 5 seconds
        run: sleep 5

      - name: Debug
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Base ref: ${{ github.base_ref }}"

  check-default-branch:
    name: Check default branch lock
    runs-on: ubuntu-latest
    needs: [dev]
    if: github.event_name == 'pull_request' && github.base_ref == 'refs/heads/main'

    permissions:
      statuses: write

    steps:
      - name: Create PR status
        uses: actions/github-script@v8
        env:
          SHA: ${{ github.event.pull_request.head.sha }}
        with:
          script: |
            console.log('Checking default branch deployment status...');
            const { data: branch } = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: "main"
            });
            console.log(`Default branch commit SHA: ${branch.commit.sha}`);

            const deploymentPages = github.paginate.iterator(github.rest.repos.listDeployments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch.commit.sha,
              environment: "Production"
            });

            let isDeployed = false;
            outer: for await (const { data: deploymentPage } of deploymentPages) {
              console.log(`Checking ${deploymentPage.length} deployment(s)...`);
              for (const deployment of deploymentPage) {
                const statusPages = github.paginate.iterator(github.rest.repos.listDeploymentStatuses, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });

                for await (const { data: statusPage } of statusPages) {
                  console.log(`Checking ${statusPage.length} status(es) for deployment ${deployment.id}...`);
                  if (statusPage.length > 0 && statusPage[0].state === "success") {
                    console.log(`Found successful deployment: ${deployment.id}`);
                    isDeployed = true;
                    break outer;
                  }
                }
              }
            }

            // Create a commit status depending on the deployment status
            console.log(`Creating commit status: ${isDeployed ? 'success' : 'pending'}`);
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.SHA,
              context: "Default branch deployment",
              state: isDeployed ? "success" : "pending",
              description: isDeployed ? "Ready for merge" : "Un-deployed changes"
            });

  lock-default-branch:
    name: Lock default branch
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      statuses: write

    steps:
      - name: Create PR statuses
        uses: actions/github-script@v8
        with:
          script: |
            console.log('Locking default branch - setting PRs to pending...');
            // Find all open PRs targeting main
            const prPages = github.paginate.iterator(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main',
            });

            // Find our commit status with context "Default branch deployment" for
            // each PR and update it to "success"
            for await (const { data: prPage } of prPages) {
              console.log(`Processing ${prPage.length} PR(s)...`);
              for (const pr of prPage) {
                console.log(`Checking PR #${pr.number}...`);
                const statusPages = github.paginate.iterator(github.rest.repos.listCommitStatusesForRef, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head.sha,
                });

                for await (const { data: statusPage } of statusPages) {
                  console.log(`Checking ${statusPage.length} status(es) for PR #${pr.number}...`);
                  for (const status of statusPage) {
                    if (status.context === "Default branch deployment") {
                      console.log(`Updating PR #${pr.number} status to pending`);
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: pr.head.sha,
                        state: "pending",
                        context: "Default branch deployment",
                        description: "Un-deployed changes"
                      });
                    }
                  }
                }
              }
            }

  stg:
    name: Staging
    runs-on: ubuntu-latest
    needs: [dev, lock-default-branch] # Since this needs lock, it will only run on pushes to default branch

    environment:
      name: Staging

    steps:
      - name: Sleep for 5 seconds
        run: sleep 5

  prd:
    name: Production
    runs-on: ubuntu-latest
    needs: [stg]

    environment:
      name: Production

    steps:
      - name: Sleep for 30 seconds
        run: sleep 30

      - name: Fail or succeed based on commit message
        run: |
          if [[ "${{ github.event.head_commit.message }}" != "succeed" ]]; then
            exit 1
          fi

  unlock-default-branch:
    name: Unlock default branch
    runs-on: ubuntu-latest
    needs: [prd]

    permissions:
      statuses: write

    steps:
      - name: Create PR statuses
        uses: actions/github-script@v8
        with:
          script: |
            console.log('Unlocking default branch - setting PRs to success...');
            // Find all open PRs targeting main
            const prPages = github.paginate.iterator(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main',
            });

            // Find our commit status with context "Default branch deployment" for
            // each PR and update it to "success"
            for await (const { data: prPage } of prPages) {
              console.log(`Processing ${prPage.length} PR(s)...`);
              for (const pr of prPage) {
                console.log(`Checking PR #${pr.number}...`);
                const statusPages = github.paginate.iterator(github.rest.repos.listCommitStatusesForRef, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head.sha,
                });

                for await (const { data: statusPage } of statusPages) {
                  console.log(`Checking ${statusPage.length} status(es) for PR #${pr.number}...`);
                  for (const status of statusPage) {
                    if (status.context === "Default branch deployment") {
                      console.log(`Updating PR #${pr.number} status to success`);
                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: pr.head.sha,
                        state: "success",
                        context: "Default branch deployment",
                        description: "Ready for merge"
                      });
                    }
                  }
                }
              }
            }
